# 要件定義書

# BLE 距離検知で映像・音声を再生する展示システム（Wi-Fi 無し）

---

## 1. プロジェクト概要

### 1.1 プロジェクト名

Beacon-System-Sample

### 1.2 目的

Wi-Fi を使わず、ESP32 を持ったオブジェクトが展示 PC の近傍に入ったときに、PC 側で映像を自動再生し、オブジェクト（ESP32）側で有線スピーカーから音声を自動再生する展示システムを実現する。

### 1.3 背景

展示会や博物館などで、オブジェクトを近づけることで自動的に映像・音声コンテンツを再生するインタラクティブな展示システムを構築するため。Wi-Fi 環境が不要で、BLE（Bluetooth Low Energy）のみで動作する。

---

## 2. システム概要

### 2.1 システム構成

本システムは以下の 2 つのコンポーネントで構成される：

1. **オブジェクト側（ESP32）**

    - ESP32 が BLE ペリフェラル（GATT サーバ）として動作
    - PC から `PLAY` コマンドを受信したら、microSD 内の音声ファイルを再生
    - 有線スピーカー（DFPlayer 等、もしくは I2S → アンプ → スピーカー）で音声出力

2. **PC 側（展示用 PC）**
    - BLE で RSSI（電波強度）を常時監視
    - 対象 ESP32 の RSSI が閾値を越えたら、GATT 接続して `PLAY` コマンドを送信
    - 同時に映像を自動再生（VLC 等を使用）

### 2.2 動作フロー

1. PC が BLE スキャンで ESP32 デバイスを検出
2. ESP32 の RSSI が設定閾値を超えた場合、PC が GATT 接続を確立
3. PC が GATT 特性に `PLAY` コマンドを書き込み
4. ESP32 が `PLAY` コマンドを受信し、音声再生を開始
5. PC が映像再生を開始

---

## 3. 機能要件

### 3.1 オブジェクト側（ESP32）機能要件

#### FR-001: BLE ペリフェラル機能

-   ESP32 は BLE ペリフェラル（GATT サーバ）として動作すること
-   各オブジェクトはユニークな BLE デバイス名（例：OBJ_001, OBJ_002）を持つこと
-   BLE サービス UUID: `0000feed-0000-1000-8000-00805f9b34fb`
-   BLE 特性 UUID: `0000beef-0000-1000-8000-00805f9b34fb`

#### FR-002: コマンド受信機能

-   GATT 特性に `PLAY` コマンドが書き込まれたら、音声再生を開始すること
-   コマンドは ASCII 文字列として受信すること

#### FR-003: 音声再生機能

-   microSD カード内の MP3 ファイルを再生すること
-   DFPlayer Mini を使用する場合、トラック番号（001.mp3 等）で管理すること
-   代替案：ESP32 + I2S DAC（ES8388 / MAX98357A）+ SD カードライブラリ

#### FR-004: 再生状態管理機能

-   再生中は再トリガーを無視すること（BUSY ピンで判別）
-   クールダウン時間（デフォルト 15 秒）内の再トリガーを無視すること
-   再生終了を検知して再生状態フラグをリセットすること

#### FR-005: 音量制御機能

-   音量を設定可能とすること（DFPlayer の場合、0-30 の範囲）

### 3.2 PC 側機能要件

#### FR-101: BLE スキャン機能

-   常時 BLE スキャンを実行し、対象デバイス（`OBJ_` プレフィックス）を検出すること
-   スキャン間隔は 0.5 秒以下とすること

#### FR-102: RSSI 監視機能

-   検出したデバイスの RSSI（電波強度）を監視すること
-   RSSI が設定閾値を超えた場合、トリガー処理を実行すること
-   RSSI 閾値は環境に応じて調整可能とすること

#### FR-103: GATT 接続・コマンド送信機能

-   RSSI 閾値を超えたデバイスに対して GATT 接続を確立すること
-   接続後、GATT 特性に `PLAY` コマンド（ASCII）を書き込むこと
-   接続タイムアウトは 5 秒以内とすること

#### FR-104: 映像再生機能

-   `PLAY` コマンド送信後、指定された映像ファイルを自動再生すること
-   VLC 等の映像再生ソフトを使用すること
-   非ブロッキングで再生を開始すること

#### FR-105: デバウンス機能

-   同一デバイスに対して、一定時間（デフォルト 12 秒）内の再トリガーを防止すること
-   デバウンス時間は設定可能とすること

#### FR-106: ログ機能

-   トリガー時刻、デバイスアドレス、RSSI 値をログに記録すること

### 3.3 システム全体機能要件

#### FR-201: 複数 PC 対応

-   オブジェクトが複数 PC の境界領域に入った場合、先に GATT 接続できて `PLAY` を書き込めた PC がトリガーされる運用とする
-   必要に応じてゾーン割り当てで論理的に分離すること

#### FR-202: 離脱検知機能（C# 実装の場合）

-   デバイスが離脱した場合（一定時間 RSSI が閾値以下）、`STOP` コマンドを送信し、映像再生を停止すること
-   離脱とみなす時間は設定可能とすること（デフォルト 4 秒）

---

## 4. 非機能要件

### 4.1 パフォーマンス要件

#### NFR-001: 応答時間

-   RSSI 閾値超過から映像・音声再生開始までの時間は 3 秒以内とすること

#### NFR-002: スキャン性能

-   BLE スキャンは 3 秒以内に完了すること

### 4.2 信頼性要件

#### NFR-003: エラーハンドリング

-   GATT 接続失敗時はエラーログを記録し、処理を継続すること
-   DFPlayer 初期化失敗時はリトライ設計を実装すること（実運用時）

#### NFR-004: チャタリング防止

-   RSSI の移動平均、ヒステリシス、デバウンス（時間判定）を導入してチャタリングを防止すること

### 4.3 保守性要件

#### NFR-005: 設定の外部化

-   RSSI 閾値、デバウンス時間、映像ファイルパス等は設定ファイルまたはコード内の定数として設定可能とすること

#### NFR-006: ログ出力

-   PC 側はトリガー時刻・デバイスアドレス・RSSI をログに残すこと

### 4.4 セキュリティ要件

#### NFR-007: 誤トリガー防止

-   BLE は暗号化していない場合、野良端末の誤トリガーの可能性があるため、必要なら接続時に簡易認証（UID チェック）を導入すること

---

## 5. システム構成

### 5.1 ハードウェア構成

#### オブジェクト側

```
[ユーザーが持つオブジェクト]
  ├─ ESP32 (BLEペリフェラル / GATTサーバ)
  ├─ DFPlayer Mini or I2S DAC + microSD（音声保存）
  ├─ 小型アンプ（必要なら） → 有線スピーカー
  └─ バッテリ（モバイルバッテリ等）
```

#### PC 側

```
[各設置PC]
  ├─ USB BLEドングル（または内蔵BLE）
  ├─ Python (bleak) スクリプト：常時スキャン、RSSI判定、GATT接続→PLAY書き込み
  └─ 映像再生ソフト（VLC等）
```

### 5.2 ソフトウェア構成

#### オブジェクト側（ESP32）

-   開発環境：Arduino IDE / PlatformIO
-   使用ライブラリ：
    -   ESP32 ボード定義
    -   DFRobotDFPlayerMini ライブラリ
    -   BLE ライブラリ（ESP32 標準）

#### PC 側

-   **Python 実装**
    -   Python 3.8 以上
    -   ライブラリ：`bleak`, `python-vlc`
-   **C# 実装（Windows 専用）**
    -   .NET 6 以上
    -   NuGet パッケージ：
        -   `Windows.Devices.Bluetooth`
        -   `Windows.Devices.Enumeration`
        -   `Vlc.DotNet.Forms`

---

## 6. ハードウェア要件

### 6.1 オブジェクト側ハードウェア

#### 必須機材（1 オブジェクト分）

-   ESP32-DevKitC（または M5Stack 系） ×1
-   DFPlayer Mini（MP3 プレーヤーモジュール） ×1
    -   microSD に MP3 を入れて再生（簡単実装）
    -   代替：ESP32 + I2S DAC（ES8388 / MAX98357A）＋ SD カードライブラリ（実装はやや複雑）
-   microSD カード（音声ファイル保存用）
-   小型アンプ（PAM8403 等）※DFPlayer にアンプ内蔵でない場合
-   スピーカー（8Ω 1–3W 程度）
-   バッテリ：モバイルバッテリ or Li-ion（ESP32 + DFPlayer で数時間〜、容量設計要）

#### 配線仕様

-   ESP32 UART1 (TX/RX) → DFPlayer RX/TX
    -   例：ESP32 TX1(17) → DFPlayer RX, ESP32 RX1(16) ← DFPlayer TX
-   DFPlayer VCC → 5V（安定化電源／バッテリ）
-   DFPlayer GND → ESP32 GND → バッテリ GND
-   DFPlayer SPK+/SPK- → 小型アンプ入力 → スピーカー（もしくは DFPlayer の出力をアンプへ）
-   DFPlayer BUSY（再生中ピン） → ESP32 GPIO（再生中フラグ取得）
-   （オプション）再生トリガ用のボタンを ESP32 の GPIO に接続

### 6.2 PC 側ハードウェア

#### 必須機材

-   USB BLE ドングル（PC 側。Windows や Linux で動作確認済みのもの）
-   PC：Windows / Linux / macOS（Python 環境、VLC 等）

---

## 7. ソフトウェア要件

### 7.1 オブジェクト側（ESP32）ソフトウェア要件

#### 開発環境

-   Arduino IDE または PlatformIO
-   ESP32 ボード定義

#### 使用ライブラリ

-   DFRobotDFPlayerMini ライブラリ
-   ESP32 BLE ライブラリ（標準）

#### 実装要件

-   BLE GATT サーバの実装
-   DFPlayer 制御の実装
-   BUSY ピンによる再生状態管理
-   クールダウン機能の実装

### 7.2 PC 側ソフトウェア要件

#### Python 実装

-   Python 3.8 以上
-   インストールパッケージ：
    ```bash
    pip install bleak python-vlc
    ```

#### C# 実装（Windows 専用）

-   .NET 6 以上
-   NuGet パッケージ：
    -   `Windows.Devices.Bluetooth`
    -   `Windows.Devices.Enumeration`
    -   `Vlc.DotNet.Forms`

#### 映像再生ソフト

-   VLC 等の映像再生ソフト（Windows / Linux / macOS 対応）

---

## 8. インターフェース要件

### 8.1 BLE インターフェース

#### サービス定義

-   **サービス UUID**: `0000feed-0000-1000-8000-00805f9b34fb`
-   **特性 UUID**: `0000beef-0000-1000-8000-00805f9b34fb`
-   **特性プロパティ**: WRITE

#### コマンド仕様

-   **PLAY コマンド**: ASCII 文字列 `"PLAY"` を GATT 特性に書き込み
-   **STOP コマンド**（C# 実装の場合）: ASCII 文字列 `"STOP"` を GATT 特性に書き込み

### 8.2 デバイス名仕様

-   デバイス名は `OBJ_` で始まるプレフィックスを持つこと
-   各オブジェクトはユニークな識別子を持つこと（例：OBJ_001, OBJ_002）

### 8.3 音声ファイル仕様

-   フォーマット：MP3
-   ファイル名：トラック番号形式（例：001.mp3, 002.mp3）
-   保存場所：microSD カード

---

## 9. 制約事項

### 9.1 技術的制約

-   Wi-Fi は使用しない（BLE のみで通信）
-   音声出力は有線スピーカーのみ（無線スピーカーは使用しない）

### 9.2 環境制約

-   RSSI は環境依存（金属、壁、人体、角度で大きく変動）
-   現地で必ず測定して閾値を決める必要がある

### 9.3 運用制約

-   バッテリ駆動のため、電源管理が必要
-   展示運用では予備充電スケジュールを作る必要がある

---

## 10. 運用要件

### 10.1 キャリブレーション要件

#### RSSI キャリブレーション

-   オブジェクトを想定位置（再生ポイント）に置き、その位置で PC が取得する RSSI を 30 ～ 50 サンプル取得すること
-   取得した RSSI の平均を閾値として設定すること
-   ヒステリシスを導入すること（入る閾値と出る閾値を分けてチャタリングを防ぐ）
    -   例：入る -60、出る -70

### 10.2 設定パラメータ

#### PC 側設定項目

-   `TARGET_NAME_PREFIX`: ESP32 の advertise 名のプレフィックス（デフォルト: "OBJ\_"）
-   `CMD_CHAR_UUID`: コマンド特性 UUID
-   `RSSI_THRESHOLD`: RSSI 閾値（例: -60、現地で要調整）
-   `DEBOUNCE_SEC`: 同一デバイス再トリガー防止時間（秒、デフォルト: 12 秒、推奨: 10〜30 秒）
-   `VIDEO_PATH`: 再生する動画のパス
-   `VLC_CMD`: VLC コマンド（環境に合わせて設定）

#### ESP32 側設定項目

-   `COOLDOWN_MS`: 再トリガーを防ぐクールダウン時間（ミリ秒、デフォルト: 15000）
-   `DFPLAYER_BUSY_PIN`: BUSY ピンの GPIO 番号（例: 4）
-   `SERVICE_UUID`: BLE サービス UUID
-   `CHAR_CMD_UUID`: BLE 特性 UUID
-   音量設定（DFPlayer の場合、0-30 の範囲）

### 10.3 電源管理要件

-   バッテリ残量監視機能の実装を推奨
-   予備充電スケジュールを作成すること（展示運用では重要）

### 10.4 ノイズ対策要件

-   電源のデカップリング（コンデンサ）を実装すること
-   GND ループ対策を実施すること
-   GND を正しくまとめること
-   アンプのアース回りを確認すること

---

## 11. デプロイ要件

### 11.1 デプロイ前チェックリスト

-   [ ] 各オブジェクトにユニークな BLE 名（例：OBJ_001, OBJ_002）を設定しているか
-   [ ] microSD に再生用ファイル（001.mp3 等）を配置しているか（フォーマット確認）
-   [ ] DFPlayer の BUSY ピンを ESP32 に接続して再生状態を取得できるか
-   [ ] PC の BLE ドングルが安定してスキャンできるか（ドライバ/権限）
-   [ ] 現地で RSSI キャリブレーションを実施し閾値を決めたか（複数サンプル）
-   [ ] DEBOUNCE/COOLDOWN 値を実使用に合わせて調整したか（例：10〜30 秒）
-   [ ] 音量調整、ノイズ対策（電源デカップリング）を実施したか
-   [ ] 複数 PC での競合ルール（先着/ゾーン割り当て）を決め、運用担当に周知したか

### 11.2 デプロイ環境要件

-   PC の BLE ドングルドライバが正しくインストールされていること
-   Python 環境（Python 実装の場合）または .NET 環境（C# 実装の場合）が整備されていること
-   VLC 等の映像再生ソフトがインストールされていること
-   映像ファイルが指定パスに配置されていること

---

## 12. トラブルシューティング

### 12.1 よくある問題と対策

#### 問題 1: トリガーが頻繁にチラつく（チャタリング）

**対策**:

-   RSSI の移動平均を導入
-   ヒステリシスを導入（入る閾値と出る閾値を分ける）
-   デバウンス（時間判定）を導入

#### 問題 2: 音が割れる・ノイズがある

**対策**:

-   電源のデカップリング（コンデンサ）を入れる
-   GND を正しくまとめる
-   アンプのアース回りを確認

#### 問題 3: 複数 PC から同時にアクセスされ再生競合が起きる

**対策**:

-   ESP32 で「再生中は書き込みを無視」する実装
-   PC 側でゾーン分けを行う

#### 問題 4: バッテリがすぐ切れる

**対策**:

-   消費電力を測定し、バッテリ容量を増やす
-   ESP32 のビーコン出力を間欠にして省電力化を検討

---

## 13. 付録

### 13.1 参考実装

詳細な実装コードは README.md を参照すること。

### 13.2 用語集

-   **RSSI**: Received Signal Strength Indicator（受信信号強度指標）
-   **GATT**: Generic Attribute Profile（BLE のプロファイル）
-   **DFPlayer**: MP3 プレーヤーモジュール
-   **デバウンス**: 短時間の連続トリガーを防止する処理
-   **ヒステリシス**: 入る閾値と出る閾値を分けてチャタリングを防ぐ手法

---

**文書バージョン**: 1.0  
**最終更新日**: 2025 年
